name: terraform-hygiene

on:
  pull_request:
    paths:
      - "infra/gcp/**"
      - ".github/workflows/terraform-hygiene.yml"
  workflow_dispatch:

jobs:
  hygiene:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      TF_DIR: infra/gcp/cloud_run_api_demo

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Terraform fmt (check)
        run: terraform -chdir=${TF_DIR} fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=${TF_DIR} init -backend=false

      - name: Terraform validate
        run: terraform -chdir=${TF_DIR} validate

      - name: tflint (docker)
        run: |
          docker run --rm -v "${{ github.workspace }}/${TF_DIR}:/workspace" -w /workspace ghcr.io/terraform-linters/tflint:latest --init
          docker run --rm -v "${{ github.workspace }}/${TF_DIR}:/workspace" -w /workspace ghcr.io/terraform-linters/tflint:latest

      - name: tfsec (docker)
        run: docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${TF_DIR} --exclude-downloaded-modules

      - name: checkov (docker)
        run: |
          # Demo posture: skip org-policy-dependent checks that are intentionally out of scope here.
          docker run --rm -v "${{ github.workspace }}:/src" bridgecrew/checkov:latest -d /src/${TF_DIR}             --skip-check CKV_GCP_84,CKV_GCP_26,CKV2_GCP_18

      - name: conftest policy (docker)
        run: |
          set -euo pipefail
          # Pass explicit *.tf files so we don't accidentally parse .terraform/** artifacts.
          docker run --rm -v "${{ github.workspace }}:/project" -w /project openpolicyagent/conftest:latest test             --parser hcl2             --policy infra/gcp/policy             $(find infra/gcp -path "*/.terraform" -prune -o -type f -name "*.tf" -print)
