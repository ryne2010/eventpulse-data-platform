# EventPulse local development (.env)
#
# Copy to .env:
#   cp .env.example .env
#
# Then run:
#   make up
#
# Tip: For Cloud Run deployment, see docs/DEPLOY_GCP.md

# -----------------
# Core
# -----------------
# Docker Compose lane (recommended): use service DNS names.
#
# If you run the API on your host (hybrid lane), use .env.host.example instead.
DATABASE_URL=postgresql://postgres:eventpulse@postgres:5432/eventpulse
REDIS_URL=redis://redis:6379/0

# -----------------
# Storage (local-first)
# -----------------
STORAGE_BACKEND=local          # local|gcs
RAW_DATA_DIR=/data/raw
CONTRACTS_DIR=/data/contracts
INCOMING_DIR=/data/incoming
ARCHIVE_DIR=/data/archive

# For Cloud Run (STORAGE_BACKEND=gcs)
RAW_GCS_BUCKET=
RAW_GCS_PREFIX=raw

# -----------------
# Async queue
# -----------------
QUEUE_BACKEND=redis            # redis|inline|cloud_tasks

# Cloud Tasks (Cloud Run lane)
CLOUD_TASKS_PROJECT=
CLOUD_TASKS_LOCATION=
CLOUD_TASKS_QUEUE=
TASK_TARGET_BASE_URL=

# Internal auth for Cloud Tasks + other privileged endpoints
TASK_AUTH_MODE=token           # token|iam

# Local-only default token so internal endpoints (watcher, ops actions, signed URL helpers)
# work out-of-the-box. For production, set a strong random value via Secret Manager.
TASK_TOKEN=devtoken

# Public ingest auth (/api/ingest/upload)
#
# - For local dev: leave as none
# - For public Cloud Run: consider token mode to prevent drive-by uploads
INGEST_AUTH_MODE=none          # none|token
INGEST_TOKEN=

# Edge device auth (/api/edge/*)
#
# - For local dev: leave as none
# - For Cloud Run field devices: token (per-device tokens; no shared fleet secret)
EDGE_AUTH_MODE=none            # none|token
EDGE_ALLOWED_DATASETS=edge_telemetry

# Field ops tuning: how long until a device is considered offline.
# Default 600 (10 minutes) is conservative.
EDGE_OFFLINE_THRESHOLD_SECONDS=600

# Optional: bootstrap enroll token for fast field provisioning.
# If set, devices can exchange a shared enroll token for a per-device token via:
#   POST /api/edge/enroll
EDGE_ENROLL_TOKEN=

# Device-authenticated signed URL helpers (/api/edge/uploads/*)
ENABLE_EDGE_SIGNED_URLS=false

# Edge device media uploads (optional: webcam photo/video)
# These objects go to a separate prefix and are NOT ingested/processed like CSV/XLSX files.
ENABLE_EDGE_MEDIA=false
# EDGE_MEDIA_GCS_BUCKET=        # defaults to RAW_GCS_BUCKET when empty
EDGE_MEDIA_GCS_PREFIX=media
EDGE_MEDIA_ALLOWED_EXTS=.jpg,.jpeg,.png,.mp4,.webm
# EDGE_MEDIA_SIGNED_URL_EXPIRES_SECONDS=900

# -----------------
# Upload controls
# -----------------
MAX_FILE_MB=50
ALLOWED_FILE_EXTS=.csv,.xlsx,.xls

# Signed URL uploads (recommended for Cloud Run + larger files)
ENABLE_SIGNED_URLS=false
REQUIRE_SIGNED_URL_SHA256=true
SIGNED_URL_EXPIRES_SECONDS=900

# GCS event-driven ingestion (optional; pairs with GCS notifications -> /internal/events/gcs_finalize)
ENABLE_GCS_EVENT_INGESTION=false

# -----------------
# Ingestion controls
# -----------------
DRIFT_POLICY_DEFAULT=warn       # warn|fail|allow
ENABLE_INGEST_FROM_PATH=true    # local dev only; keep false in Cloud Run
ENABLE_DEMO_ENDPOINTS=true      # exposes /api/demo/* endpoints

# Processing hardening
PROCESSING_TTL_SECONDS=600
RECLAIM_MAX_PER_RUN=50
MAX_PROCESSING_ATTEMPTS=5

# -----------------
# Curated outputs
# -----------------
CURATED_BACKEND=postgres        # postgres (BigQuery adapter is a future upgrade)

# -----------------
# Logging
# -----------------
LOG_LEVEL=INFO
LOG_FORMAT=console              # console|json
